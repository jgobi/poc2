<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <style>
      * {
        font-family: sans-serif;
      }
      pre {
        font-family: monospace;
        text-align: center;
        background-color: #eee;
        padding: 10px;
      }

      .db {
        fill: #c8c8c8;
        stroke: #fefefd;
        stroke-width: 0.25;
      }

      .dot {
        fill: #5b626a;
        stroke: none;
      }
    </style>
  </head>

  <body>
    <h1>Select the statistics.json file</h1>
    <input
      id="file"
      type="file"
      onchange="change(this)"
      accept="application/json"
    />
    <hr />
    <div style="display: flex; width: 100%">
      <div style="width: 100%; padding: 10px; border-right: 1px solid black">
        <h2>Fitness evolution</h2>
        <canvas id="chart" width="400" height="200"></canvas>
      </div>
      <div style="width: 100%; padding: 10px">
        <h2>Evolution of the best individual</h2>
        <div id="ind" style="text-align: center">-</div>
        <div style="text-align: center">
          <small>Fitness: <span id="fit">-</span></small>
        </div>
        <div style="text-align: center">
          <svg
            id="svg"
            style="max-height: 50vh; background-color: #28323c"
          ></svg>
        </div>
        <div style="text-align: center">
          <button onclick="first()">&lt;&lt;</button>
          <button onclick="prev()">&lt;</button>
          <span id="cur">-</span>
          <button onclick="next()">&gt;</button>
          <button onclick="last()">&gt;&gt;</button>
        </div>
      </div>
    </div>

    <script src="chart.min.js"></script>
    <script>
      var $ = document.querySelector.bind(document);

      var chart = new Chart($("#chart"), {
        type: "line",
        options: {
          responsive: true,
          scales: {
            x: {
              title: {
                display: true,
                text: "Generations",
              },
            },
            y: {
              title: {
                display: true,
                text: "Fitness",
              },
              suggestedMin: 0,
              suggestedMax: 1,
            },
          },
        },
      });

      var statistics = [];
      var cursor = 0;

      async function change(el) {
        /** @type {File} **/
        let file = el.files[0];
        if (file && file.type == "application/json") {
          let content;
          try {
            content = JSON.parse(await file.text());
          } catch (err) {
            alert("Error parsing file, see console for more info.");
            console.error(err);
          }
          statistics = content;
          loadChart();
          loadIndividuals();
        } else {
          alert("Invalid file, please provide a valid statistics.json.");
        }
      }

      function loadChart() {
        chart.data = {
          labels: Array(statistics.length)
            .fill(0)
            .map((_, i) => i + 1),
          datasets: [
            ["minFitness", "red"],
            ["avgFitness", "blue"],
            ["bestFitness", "green"],
          ].map(([label, borderColor]) => ({
            label,
            data: statistics.map((s) => s[label]),
            fill: false,
            borderColor,
            tension: 0,
          })),
        };
        chart.update();
      }

      function loadIndividuals() {
        $("#ind").innerText = "-";
        $("#fit").innerText = "-";
        $("#cur").innerText = "-";

        cursor = statistics.length;
        prev();
      }

      function showIndividual() {
        const f = statistics[cursor].bestFitness;
        const ind = statistics[cursor].bestIndividual;
        $("#ind").innerText = ind.id;
        $("#fit").innerText = f;
        $("#cur").innerText = `${cursor + 1} / ${statistics.length}`;
        draw($("#svg"), ind2Drawing(ind));
      }

      function first() {
        if (statistics.length) {
          cursor = 0;
          showIndividual();
        }
      }
      function prev() {
        if (cursor >= 0) {
          cursor--;
          showIndividual();
        }
      }

      function next() {
        if (cursor < statistics.length) {
          cursor++;
          showIndividual();
        }
      }
      function last() {
        if (statistics.length) {
          cursor = statistics.length - 1;
          showIndividual();
        }
      }

      function ind2Drawing(ind) {
        const w = ind.preview.split("\n")[0].trim().split(" ").length;
        const h = ind.preview.split("\n").length;
        console.log(w, h);
        return {
          width: (w - 1) * 3.84,
          height: (h - 1) * 7.68 + 2.25,
          items: ind.gc.split("").flatMap((el, i) =>
            [0, 1].map((k) => ({
              x: (i % w) * 3.84,
              y: Math.floor(i / w) * 7.68 + k * 2.25,
              db: k + 1 === +el,
            }))
          ),
        };
      }

      function draw(svg, gc) {
        svg.innerHTML = "";
        svg.setAttribute("viewBox", `-3 -3 ${gc.width + 6} ${gc.height + 6}`);
        for (let el of gc.items) {
          const c = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "circle"
          );
          c.setAttribute("class", el.db ? "db" : "dot");
          c.setAttribute("cx", el.x);
          c.setAttribute("cy", el.y);
          c.setAttribute("r", el.db ? 0.9 : 0.4);
          svg.appendChild(c);
        }
      }
    </script>
  </body>
</html>
